package microservice.examenes.controllers;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import microservice.commons.controllers.CommonController;
import microservice.examenes.models.entity.Examen;
import microservice.examenes.models.entity.Pregunta;
import microservice.examenes.models.service.IExamenService;

@RestController
public class ExamenController extends CommonController<Examen, IExamenService>{

	@PutMapping("/{id}")
	public ResponseEntity<?>editar(@RequestBody Examen examen, @PathVariable Long id ){
		Optional<Examen> o = service.porId(id);
		if(!o.isPresent()) {
			return ResponseEntity.notFound().build();
		}
		Examen examendb = o.get();
		examendb.setNombre(examen.getNombre());
		
		//VER QUE PREGUNTAS EXISTEN EN LA BBDD, PERO NO ESTÁN EN EL JSON QUE SE ESTÁ ENVIANDO.  ESTO ES PQ SEGURAMENTE ANTES AGREGARON Y BORRARON PREGUNTAS, Y HAT Q REFLEJAR ESE CAMBIO.
		//ESTO ES TAMBN PARA ELIMINAR LAS PREGUNTAS DE LA BBDD QUE NO ESTÁN EN EL JSON.
		
		//1.-CREAR ARRAY DE LAS PREGUNTAS ELIMINADAS. SE ITERAN LAS PREGUNTAS DE LA BBDD Y SE PREGUNTA SI ESTA PREGUNTA EXISTE EN EÑ JSON QUE SE RECIBE DEL @REQUESBODY. y SI NO EXISTE LA PREGUNTA EN EL JSON, SE ELIMINA DE LA BBDDD.
		List<Pregunta>eliminadas = new ArrayList<>();
		examendb.getPreguntas().forEach(pdb -> {
			if(!examen.getPreguntas().contains(pdb)) {
				eliminadas.add(pdb);
			}
		});
		
		//2.-POR CADA PREGUNTA A ELIMINAR,  LA ELIMINAMOS.
		eliminadas.forEach(p -> {
			examendb.removePregunta(p);
		});
		
		//3.-UNA VEZ ELIMINADAS LAS PREGUNTAS DE LA BBDD Q NO ESTABAN EN EL JSON, AHORA HAY Q AGREGAR LAS NUEVAS PREGUNTAS Y MODIFICAR LAS EXISTENTES. Y LAS PREGUNTAS QUE NO SE TOCARON, QUEDAN TAL CUAL.
		examendb.setPreguntas(examen.getPreguntas());
		
		return null;
	}
	
	
	
}
